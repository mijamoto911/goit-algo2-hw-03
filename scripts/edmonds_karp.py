import networkx as nx
import pandas as pd
import matplotlib.pyplot as plt

# Створюємо орієнтований граф
G = nx.DiGraph()

# Додаємо ребра з пропускною здатністю
edges = [
    ("Термінал 1", "Склад 1", 25),
    ("Термінал 1", "Склад 2", 20),
    ("Термінал 1", "Склад 3", 15),
    ("Термінал 2", "Склад 3", 15),
    ("Термінал 2", "Склад 4", 30),
    ("Термінал 2", "Склад 2", 10),
    ("Склад 1", "Магазин 1", 15),
    ("Склад 1", "Магазин 2", 10),
    ("Склад 1", "Магазин 3", 20),
    ("Склад 2", "Магазин 4", 15),
    ("Склад 2", "Магазин 5", 10),
    ("Склад 2", "Магазин 6", 25),
    ("Склад 3", "Магазин 7", 20),
    ("Склад 3", "Магазин 8", 15),
    ("Склад 3", "Магазин 9", 10),
    ("Склад 4", "Магазин 10", 20),
    ("Склад 4", "Магазин 11", 10),
    ("Склад 4", "Магазин 12", 15),
    ("Склад 4", "Магазин 13", 5),
    ("Склад 4", "Магазин 14", 10),
]

# Додаємо ребра в граф
for u, v, w in edges:
    G.add_edge(u, v, capacity=w)

# Додаємо джерело та стік
G.add_edge("Джерело", "Термінал 1", capacity=9999)
G.add_edge("Джерело", "Термінал 2", capacity=9999)

for node in list(G.nodes):
    if "Магазин" in node:
        G.add_edge(node, "Стік", capacity=9999)

# Виконуємо алгоритм Едмондса-Карпа
max_flow_value, flow_dict = nx.maximum_flow(G, "Джерело", "Стік")

# Вивід загального максимального потоку
print(f"Максимальний потік через мережу: {max_flow_value}")

# Формуємо таблицю потоків
data = []
for term in ["Термінал 1", "Термінал 2"]:
    for store in [n for n in G.nodes if "Магазин" in n]:
        if term in flow_dict and store in flow_dict[term]:
            data.append([term, store, flow_dict[term][store]])

# Записуємо результати в DataFrame
df = pd.DataFrame(data, columns=["Термінал", "Магазин", "Фактичний Потік (одиниць)"])
df.to_csv("логістична_мережа_потоки.csv", index=False)
print("\nТаблиця потоків між терміналами та магазинами:")
print(df)

# Визначення фіксованих позицій для вузлів
pos = {
    "Джерело": (2.5, 5),
    "Термінал 1": (1, 4),
    "Термінал 2": (4, 4),
    "Склад 1": (0, 3),
    "Склад 2": (3, 3),
    "Склад 3": (2, 3),
    "Склад 4": (5, 3),
    "Магазин 1": (-0.5, 2),
    "Магазин 2": (0, 2),
    "Магазин 3": (0.5, 2),
    "Магазин 4": (1, 2),
    "Магазин 5": (1.5, 2),
    "Магазин 6": (2, 2),
    "Магазин 7": (2.5, 2),
    "Магазин 8": (3, 2),
    "Магазин 9": (3.5, 2),
    "Магазин 10": (4, 2),
    "Магазин 11": (4.5, 2),
    "Магазин 12": (5, 2),
    "Магазин 13": (5.5, 2),
    "Магазин 14": (6, 2),
    "Стік": (2.5, 1),
}

# Візуалізація мережі
plt.figure(figsize=(12, 7))
nx.draw(
    G,
    pos,
    with_labels=True,
    node_size=2000,
    node_color="lightblue",
    font_size=10,
    edge_color="gray",
)

# Додаємо мітки потоків
edge_labels = {(u, v): flow_dict[u][v] for u, v in G.edges if flow_dict[u][v] > 0}
nx.draw_networkx_edge_labels(G, pos, edge_labels=edge_labels, font_size=9)

plt.title("Логістична мережа з потоками")
plt.show()
